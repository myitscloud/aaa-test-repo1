# Continuous Integration Workflow
# Multi-language CI that auto-detects project type

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Detect which languages/frameworks are present
  detect:
    name: Detect Project Type
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.check.outputs.python }}
      node: ${{ steps.check.outputs.node }}
      powershell: ${{ steps.check.outputs.powershell }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for project types
        id: check
        run: |
          # Check for Python
          if [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            echo "python=true" >> $GITHUB_OUTPUT
          else
            echo "python=false" >> $GITHUB_OUTPUT
          fi

          # Check for Node.js
          if [ -f "package.json" ]; then
            echo "node=true" >> $GITHUB_OUTPUT
          else
            echo "node=false" >> $GITHUB_OUTPUT
          fi

          # Check for PowerShell
          if ls *.psd1 1> /dev/null 2>&1 || ls *.psm1 1> /dev/null 2>&1; then
            echo "powershell=true" >> $GITHUB_OUTPUT
          else
            echo "powershell=false" >> $GITHUB_OUTPUT
          fi

  # Python CI Pipeline
  python:
    name: Python CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.python == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Check formatting with Black
        run: |
          black --check --diff . || echo "::warning::Code formatting issues found. Run 'black .' to fix."
        continue-on-error: true

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff . || echo "::warning::Import sorting issues found. Run 'isort .' to fix."
        continue-on-error: true

      - name: Lint with flake8
        run: |
          # Stop on syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Warnings for everything else
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Run tests with pytest
        run: |
          if [ -d "tests" ]; then
            pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing -v
          else
            echo "No tests directory found, skipping tests"
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # Node.js CI Pipeline
  node:
    name: Node.js CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.node == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: |
          if npm run lint --if-present; then
            echo "Linting passed"
          else
            echo "::warning::Linting issues found or no lint script defined"
          fi
        continue-on-error: true

      - name: Run type checking
        run: |
          npm run typecheck --if-present || echo "No typecheck script defined"
        continue-on-error: true

      - name: Run tests
        run: |
          npm test --if-present || echo "No test script defined"

      - name: Build
        run: |
          npm run build --if-present || echo "No build script defined"

  # PowerShell CI Pipeline
  powershell:
    name: PowerShell CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.powershell == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Severity Warning,Error
          if ($results) {
            $results | Format-Table -AutoSize
            if ($results | Where-Object { $_.Severity -eq 'Error' }) {
              throw "PSScriptAnalyzer found errors"
            }
          } else {
            Write-Host "No issues found"
          }

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -Force -Scope CurrentUser -MinimumVersion 5.0
          $config = New-PesterConfiguration
          $config.Run.Path = "./tests"
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          if (Test-Path "./tests") {
            Invoke-Pester -Configuration $config
          } else {
            Write-Host "No tests directory found"
          }

  # Build and push Docker image (if Dockerfile exists)
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [python, node, powershell]
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Dockerfile
        id: docker-check
        run: |
          if [ -f "Dockerfile" ] || [ -f "infrastructure/docker/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.docker-check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        if: steps.docker-check.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ hashFiles('Dockerfile') != '' && 'Dockerfile' || 'infrastructure/docker/Dockerfile' }}
          push: false
          tags: ${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip Docker build
        if: steps.docker-check.outputs.exists == 'false'
        run: echo "No Dockerfile found, skipping Docker build"

  # Final status check
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [detect, python, node, powershell, docker]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "Detection: ${{ needs.detect.result }}"
          echo "Python: ${{ needs.python.result }}"
          echo "Node.js: ${{ needs.node.result }}"
          echo "PowerShell: ${{ needs.powershell.result }}"
          echo "Docker: ${{ needs.docker.result }}"

          if [[ "${{ needs.detect.result }}" == "failure" ]]; then
            echo "Detection failed"
            exit 1
          fi

          # Check if any enabled job failed
          if [[ "${{ needs.python.result }}" == "failure" ]] || \
             [[ "${{ needs.node.result }}" == "failure" ]] || \
             [[ "${{ needs.powershell.result }}" == "failure" ]] || \
             [[ "${{ needs.docker.result }}" == "failure" ]]; then
            echo "One or more CI jobs failed"
            exit 1
          fi

          echo "All CI checks passed!"
